// This is your Prisma schema file for the Central SIM Management System

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum SimStatus {
  IN_STOCK   // 在庫（利用可能）
  ACTIVE     // 利用中
  RETURNING  // 返却待ち
  RETIRED    // 廃棄/契約終了
}

// ==================== MAIN MODELS ====================

// SIM基本情報（中央マスタ）
model Sim {
  iccid                    String        @id @db.VarChar(20)
  msisdn                   String?       @db.VarChar(20) // 電話番号（CSVまたは手入力）

  // 仕入れ先情報
  supplier                 String        @db.VarChar(50) // アーツ / ソフィア
  ownerCompany             String?       @db.VarChar(100)
  plan                     String?       @db.VarChar(100)
  customerType             String?       @db.VarChar(50)

  // 仕入れ先契約期間（CSVから）
  supplierServiceStartDate DateTime?
  supplierServiceEndDate   DateTime?

  // 現在の割当状態（高速検索用の非正規化）
  currentServiceName       String?       @db.VarChar(50) // 物販/バーサス/Avaris
  currentCustomerId        String?       @db.VarChar(100) // 既存サービスDBの顧客ID
  currentContractStartDate DateTime?
  currentContractEndDate   DateTime?

  // ステータス
  status                   SimStatus     @default(IN_STOCK)

  // メタデータ
  createdAt                DateTime      @default(now())
  updatedAt                DateTime      @updatedAt

  // リレーション
  history                  SimHistory[]

  // インデックス
  @@index([status])
  @@index([supplier])
  @@index([currentServiceName])
  @@index([msisdn])
}

// SIM履歴（顧客ごとの契約記録）
model SimHistory {
  id                  String    @id @default(cuid())
  iccid               String    @db.VarChar(20)

  // 割当詳細
  serviceName         String    @db.VarChar(50) // 物販/バーサス/Avaris
  customerId          String?   @db.VarChar(100) // 既存サービスDBの顧客ID

  // 契約期間
  contractStartDate   DateTime?
  contractEndDate     DateTime?

  // 配送追跡
  shippedDate         DateTime?
  arrivedDate         DateTime?
  returnedDate        DateTime?

  // 用途分類
  usageTagId          Int?
  msisdnSnapshot      String?   @db.VarChar(20) // 割当時の電話番号

  // メタデータ
  createdAt           DateTime  @default(now())

  // リレーション
  sim                 Sim       @relation(fields: [iccid], references: [iccid], onDelete: Cascade)
  usageTag            UsageTag? @relation(fields: [usageTagId], references: [id], onDelete: SetNull)

  // インデックス
  @@index([iccid])
  @@index([serviceName])
  @@index([customerId])
  @@index([usageTagId])
  @@index([contractStartDate, contractEndDate])
}

// 既存サービスDB接続情報（Supabaseインスタンス）
model ServiceSource {
  id              Int       @id @default(autoincrement())
  name            String    @unique @db.VarChar(50) // buppan/versus/avaris
  displayName     String    @db.VarChar(100) // 物販/バーサス/Avaris

  // Supabase接続詳細
  supabaseUrl     String    @db.VarChar(255)
  serviceRoleKey  String    @db.Text // ENCRYPTION_KEYで暗号化済み

  // テーブルマッピング（異なるスキーマ対応）
  tableName       String    @db.VarChar(100) // 例: "subscriptions" or "sim_contracts"

  // カラムマッピング（柔軟性のためJSON）
  columnMappings  Json      @default("{\"iccid\": \"iccid\", \"customerId\": \"customer_id\", \"contractStartDate\": \"start_date\", \"contractEndDate\": \"end_date\"}")

  // 同期設定
  enabled         Boolean   @default(true)
  lastSyncAt      DateTime?
  lastSyncStatus  String?   @db.Text // エラーメッセージまたは "success"

  // メタデータ
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // インデックス
  @@index([enabled])
}

// 用途タグマスタ
model UsageTag {
  id          Int          @id @default(autoincrement())
  name        String       @unique @db.VarChar(100) // ポケカ認証/物販/アダアフィ
  description String?      @db.Text

  // メタデータ
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // リレーション
  history     SimHistory[]
  rules       UsageRule[]
}

// 販売可能判定ルール
model UsageRule {
  id               Int       @id @default(autoincrement())
  usageTagId       Int

  // フィルタ条件
  supplierFilter   String?   @db.VarChar(50) // null = 全仕入れ先, または特定: アーツ/ソフィア
  planFilter       String?   @db.VarChar(100) // null = 全プラン, または特定プラン名

  // 最低契約要件
  minContractDays  Int       @default(0) // SIMが利用可能でなければならない最低日数

  // 拡張可能条件（将来の要件用）
  conditions       Json      @default("{}") // 例: {"requiresData": true, "excludeCustomerTypes": ["test"]}

  // 優先順位（高い値 = 先にチェック）
  priority         Int       @default(0)

  // メタデータ
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // リレーション
  usageTag         UsageTag  @relation(fields: [usageTagId], references: [id], onDelete: Cascade)

  // インデックス
  @@index([usageTagId])
  @@index([priority])
}

// 同期操作・データ変更の監査ログ
model SyncLog {
  id              String    @id @default(cuid())
  serviceName     String?   @db.VarChar(50)
  operation       String    @db.VarChar(50) // "sync", "csv_import", "manual_update"
  status          String    @db.VarChar(20) // "started", "completed", "failed"
  recordsAffected Int       @default(0)
  errorMessage    String?   @db.Text
  metadata        Json      @default("{}")

  createdAt       DateTime  @default(now())

  // インデックス
  @@index([serviceName])
  @@index([operation])
  @@index([createdAt])
}
